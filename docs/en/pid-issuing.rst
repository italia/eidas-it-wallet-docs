.. include:: ../common/common_definitions.rst

.. _pid_issuing.rst:

PID Issuing
+++++++++++

The relevant entities and interfaces involved in the issuing flows are:

    - *Wallet Provider*: It represents an organization (public or private) that is responsible for the release of an eIDAS-compliant EUDI Wallet solution. It also issues to the Wallet Instance a Wallet Attestation by means of an Attestation Service. The Wallet Attestation certifies the genuinity and authenticity of the Wallet Instance and its compliance with a trust framework (e.g., with respect to the relevant security and privacy requirements).
    - *Wallet Solution*: It represents the entire product and service owned by a Wallet Provider, offered to all Users of that solution. A Wallet Solution can be certified as being EUDI-compliant by a Conformity Assessment Body (CAB).
    - *Wallet Instance*: the Wallet Solution is instantiated to Wallet Instance through installation and initialization on the User's device. it provides interfaces for User interaction with the Wallet Solution backend. 
    - *PID Provider*: It represents the issuer of eIDAS Person Identification Data (PID). It is composed of:

        - OIDC VCI Component: based on the “OpenID for Verifiable Credential Issuance” specification  `[OIDC4VCI. Draft 13] <https://openid.bitbucket.io/connect/openid-4-verifiable-credential-issuance-1_0.html>`_ to release PID credentials.
        - National eID component (OIDC Core or SAML2): It represents the component to authenticate the End-User with the National IdPs.
    - National IdP: It represents preexisting identity systems based on SAML2 or OIDC, already in production in each Member State (for Italy SPID and CIE id authentication schemed notified eIDAS with *LoA* **High**).
    
.. _fig_High-Level-Flow-EUDIW-PID-Issuing:
.. figure:: ../../images/High-Level-Flow-EUDIW-PID-Issuing.svg
    :figwidth: 100%
    :align: center

    PID Issuing - General architecture and high level flow

The :numref:`fig_High-Level-Flow-EUDIW-PID-Issuing` shows a general architecture and highlights the main operations involved in the issuing of a PID, in particular:

    0. **EUDI Wallet Instance Setup**: the first time the Wallet Instance is started a preliminary setup phase MUST be carried out. It consists of the release of a verifiable proof issued by the Attestation Service provided by the Wallet Provider that asserts the genuineness, the authenticity and the compliance with a trust framework of the Wallet Instance. The verifiable proof binds a public key corresponding to a local private key generated by the Wallet Instance. 
    1. **Obtaining the trusted PID Provider**: the Wallet Instance queries the Trust Anchor to fetch the trusted PID Provider. 
    2. **Obtaining of PID Provider metadata**: the Wallet Instance fetches the Entity Statement of the PID Provider from the Trust Anchor and can establish the trust and obtain the Metadata that discloses the types of PIDs, their formats, the algorithms supported, and any other parameter required for interoperability needs.
    3. **PID request**: following the Authorization Code Flow in `[OIDC4VCI. Draft 13] <https://openid.bitbucket.io/connect/openid-4-verifiable-credential-issuance-1_0.html>`_ the Wallet Instance requests a PID to the PID Provider. A fresh key pairs is generated by the Wallet Instance and the public key is used to bind the PID
    4. **End-user authentication**: the PID Provider authenticates the End-User using a traditional eIDAS high LoA SAML2/OIDC authentication acting as an IAM Proxy. 
    5. **PID issuance**: finally, after the End-User authentication with LoA High and consent, and the check of the Wallet Instance by means of the Wallet Attestation and the Trust Chain related to the Wallet Provider as the provider of a compliant Wallet Solution, the PID Provider responds with a PID, bound to key material as requested.


Detailed Flow
-------------

.. _fig_Low-Level-Flow-EUDIW-PID-Issuing:
.. figure:: ../../images/Low-Level-Flow-EUDIW-PID-Issuing.svg
    :figwidth: 100%
    :align: center
    :target: https://www.plantuml.com/plantuml/png/hLHXQ-D64Fs-lsB87JG1ctuF-BXBurvCGmdN7FUb8DRIs1eYxwexirRTNz_HIZ8hznhouI0WillclJTlP_oHnGQ9XyROADx5mnQ3CQsUKKcjTG9NNnd35LY6QCpM_pqS_CJ01qMrjNTu1UyUQL_BNHDnNdiNV7Skj_ExRxPfK63Zr88hCM4wWwu2LJ7VnJu5VwHgvDjUO9usztC0NG1mS__f3yXXyATx3f45AtWabbGbnfZLAi68EPBR0wnMndIm_03n5lnMB3au-HXwa8cmr8lk5ax8nWJd1S4VbRjR2Bpxzh1vNfknnaAZAk1tCAdcPlhMKxbgBJ-eKkdTZi81f4PWRB0KyawhvrKcghxA-vSBTT9NsNn-UFxyPRt-tLoa3MMDvGihjvKaC8k56FhaL2lT_OfwQ9EwTTMK00d30SLMLcpk7VeuGEq7jAB4l_sorbOg1BL5Ey8mOaWngWBN0RdrZh6GKuiBK8EYdx8XT59GjKZLHLdt7RWzNlvVg8dQAyn6_GRw9pajAbIN3IyWO4L1mojYe3EjPSQGS8FevV7g_H3ObDSd4MH9pEzl80-Q5jjPqBCWBrCUIDyIzEiyJ7jd9GRKofmuimdfhKWOZhQXYkG4sIiPWkNuJW7_YiWf7Ztlqdcqj-Su4QwpjyZGDoRQXAOtWSqyjJWjHzJ8KxrMKJbuxqXg6FRrWVPrQgNqZXMIDK6ZLyZrfsbI8xx2iyVkDL0sjNjq_HCWt3_v9tZ1q__UjS5h-3iVvhiZ_WKTgCdMaxhDXZtTpFBP1-jaca1VJQCzBSe2bAGjaj0FcTpvCjoa1CTeoXAPYsHHEGldjVHxhUyqkhhF9NLUAf-gast-i_XZFlhNUcOb9w_DZymfyHp_UgYPpZdPB5XYZfXZhcVjP3TZPif_iBA08TbC-MO-fEDYtpr-NPilk2SMFTLqGUfSRncmiO8L6783jVQQcaWlEGxrpm6FVfplV1NFRw0TPwIJI-qp1qpBd5QYVzV8mwz3XcFn8VTdFgfQF3J_0W00

    PID Issuing - Detailed flow

